{% extends "base.html" %}

{% block title %}Historical Data{% endblock %}

{% block content %}
<h1 class="mb-4">ðŸ“Š Historical Stock Data</h1>

<!-- Input Section -->
<div class="card mb-4 shadow-sm">
  <div class="card-body">
    <form method="POST">
      <div class="row g-3 align-items-center">
        <div class="col-auto">
          <input type="text" name="symbol" value="{{ symbol }}" class="form-control"
                 placeholder="Enter stock symbol (e.g. AAPL)" required>
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-primary">View History</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% if history_data %}
<div class="mb-4">
  <h2>Performance of <b>{{ symbol.upper() }}</b>  
    <small class="text-muted">({{ history_data.start_date }} â†’ {{ history_data.end_date }})</small>
  </h2>
</div>

<!-- Chart Section -->
<div class="card mb-4 shadow-sm">
  <div class="card-body">
    <div id="stock-chart"></div>
  </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-center shadow-sm">
      <div class="card-body">
        <h6 class="text-muted">Latest Close</h6>
        <h4>${{ summary.latest_close }}</h4>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center shadow-sm">
      <div class="card-body">
        <h6 class="text-muted">Return</h6>
        <h4>{{ summary.return_pct }}%</h4>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center shadow-sm">
      <div class="card-body">
        <h6 class="text-muted">Highest Price</h6>
        <h4>${{ summary.highest }}</h4>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center shadow-sm">
      <div class="card-body">
        <h6 class="text-muted">Lowest Price</h6>
        <h4>${{ summary.lowest }}</h4>
      </div>
    </div>
  </div>
</div>

<!-- Historical Table -->
<div class="card shadow-sm">
  <div class="card-body">
    <h4>ðŸ“… Daily Data</h4>
    <table class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th>Date</th>
          <th>Open</th>
          <th>High</th>
          <th>Low</th>
          <th>Close</th>
          <th>Volume</th>
        </tr>
      </thead>
      <tbody>
        {% for row in history_data.data %}
        <tr>
          <td>{{ row.date.strftime("%Y-%m-%d") }}</td>
          <td>{{ row.open }}</td>
          <td>{{ row.high }}</td>
          <td>{{ row.low }}</td>
          <td>{{ row.close }}</td>
          <td>{{ row.volume }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Pagination -->
<nav class="mt-3">
  <ul class="pagination">
    <li class="page-item {% if history_data.page == 1 %}disabled{% endif %}">
      <a class="page-link" href="?symbol={{ symbol }}&page={{ history_data.page - 1 }}">Previous</a>
    </li>

    {% for p in range(1, history_data.total_pages + 1) %}
    <li class="page-item {% if p == history_data.page %}active{% endif %}">
      <a class="page-link" href="?symbol={{ symbol }}&page={{ p }}">{{ p }}</a>
    </li>
    {% endfor %}

    <li class="page-item {% if history_data.page == history_data.total_pages %}disabled{% endif %}">
      <a class="page-link" href="?symbol={{ symbol }}&page={{ history_data.page + 1 }}">Next</a>
    </li>
  </ul>
</nav>
{% endif %}

<!-- Plotly Script -->
{% if chart_json %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
  var chartData = JSON.parse({{ chart_json | tojson | safe }});
  Plotly.newPlot('stock-chart', chartData.data, chartData.layout);
</script>
{% endif %}
{% endblock %}
